<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//TEST_AMDTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.server.model.dao.manager.DepartmentMapper">
    <select id="validDeptId" resultType="Integer">
        select exists(select * from DEPARTMENT where id = #{id} limit  1) as success;
    </select>

    <select id="findByDeptInfo" resultType="Department">
        SELECT name, location, start_time, end_time FROM DEPARTMENT where id = #{id};
    </select>

    <update id="updateByOne">
        UPDATE DEPARTMENT SET start_time = #{startTime}, end_time=#{endTime} where id=#{id}
    </update>

    <select id="findByVacationAll" resultType="VacationView">
        SELECT VACATION.id as vId, VACATION.username, name, date, vacation_type as type, contents, rest_time as restTime, approval_flag as approvalFlag
        FROM VACATION INNER JOIN EMPLOYEE
        ON VACATION.username = EMPLOYEE.username
        WHERE dep_id = #{id};
    </select>

    <select id="validVid" resultType="Integer">
        select exists(select * from VACATION where id = #{vId} limit 1) as success;
    </select>

    <update id="updateVacationByOne">
        UPDATE VACATION
        SET approval_flag = #{approvalFlag}
        WHERE id = #{vId};
    </update>

    <select id="findByRearrangeAll" resultType="RearrangeView">
        SELECT REARRANGE.id as rId, a_id as aId, A.username, name, img, contents, REARRANGE.start_time as rStartTime, REARRANGE.end_time as rEndTime, A.start_time as startTime, A.end_time as endTime, approval_flag as approvalFlag
        from REARRANGE
        INNER JOIN ATTENDANCE A on REARRANGE.a_id = A.id
        INNER JOIN EMPLOYEE E on A.username = E.username
        WHERE dep_id = #{id};
    </select>

    <update id="updateRearrangeByOne">
        call REARRANGE_UPDATE(#{rId},#{aId},#{startTime},#{endTime},#{approvalFlag},@resCode,@resMsg);
    </update>
    <select id="checkRearrangeUpdate" resultType="ResultAction">
        select @resCode, @resMsg as result;
    </select>

    <select id="findEmpAllByDepId" resultType="User">
        SELECT username, D.name as department, E.name as name, email, gender, position, created_at as createdAt
        FROM EMPLOYEE E INNER JOIN DEPARTMENT D ON E.dep_id = D.id
        WHERE dep_id = #{id};
    </select>
</mapper>